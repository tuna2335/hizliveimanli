<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Hızlı ve İmanlı - 5. Soru</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 30px; }
  .hidden { display: none; }
  button:disabled { background-color: #ccc; }
  .answered { color: #bbb; }
  #penalty { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>5. Soru</h2>
<p id="penalty" class="hidden"></p>
<div id="questionArea">
  <p>En iyi hoca kimdir?</p>
  <button data-answer="a">a) aykut hoca</button>
  <button data-answer="b">b) ibrahim hoca</button>
  <button data-answer="c">c) miray hoca</button>
  <button data-answer="d">d) serhat hoca</button>
  <button data-answer="e">e) necmettin hoca</button>
</div>

<div id="puzzle" class="hidden">
  <p><strong>Ödül basamağına ulaştınız!</strong> Oyunu kazandınız. Tebrikler!</p>
</div>

<script>
// Firebase yapılandırması:
const firebaseConfig = {
  apiKey: "AIzaSyAySqZBG0_xpbxnsR8hZo3_Mz6vc57gtys",
  authDomain: "hizliveimanli-ce2e8.firebaseapp.com",
  projectId: "hizliveimanli-ce2e8",
  storageBucket: "hizliveimanli-ce2e8.appspot.com",
  messagingSenderId: "841569685733",
  appId: "1:841569685733:web:85bbd615217216142f440c",
  measurementId: "G-TYK4R241V4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const playerName = urlParams.get("name");
if(!playerName){
  alert("Lütfen isimle giriş yapın.");
  window.location = "index.html";
}

const playerRef = db.collection("players").doc(playerName);

const correctAnswer = "b";
let penaltyCount = 0;

const penaltyDisplay = document.getElementById("penalty");
const questionArea = document.getElementById("questionArea");
const puzzleDiv = document.getElementById("puzzle");

async function disableButtons() {
  document.querySelectorAll("#questionArea button").forEach(b=>{
    b.disabled = true;
  });
}

function markButtonWrong(btn) {
  btn.classList.add("answered");
  btn.style.color = "#bbb";
}

async function checkPenalty(){
  const doc = await playerRef.get();
  if(!doc.exists){
    alert("Oyuncu bulunamadı.");
    window.location = "index.html";
    return false;
  }
  const data = doc.data();
  const now = Date.now();

  if(data.stage !== "5.soru"){
    alert("Bu soruyu şu anda çözemezsiniz.");
    window.location = "index.html";
    return false;
  }

  if(data.penaltyUntil && data.penaltyUntil > now){
    const secondsLeft = Math.ceil((data.penaltyUntil - now)/1000);
    penaltyDisplay.textContent = `Ceza süresi: ${secondsLeft} saniye. Lütfen bekleyin.`;
    penaltyDisplay.classList.remove("hidden");
    await disableButtons();
    setTimeout(checkPenalty, 1000);
    return true;
  } else {
    penaltyDisplay.classList.add("hidden");
    return false;
  }
}

async function handleAnswer(event){
  const btn = event.target;
  const answer = btn.getAttribute("data-answer");
  const doc = await playerRef.get();
  if(!doc.exists) return;

  const data = doc.data();

  if(data.penaltyUntil && data.penaltyUntil > Date.now()){
    return;
  }

  if(answer === correctAnswer){
    await playerRef.update({
      stage: "ödül",
      penaltyUntil: 0,
      wrongCount: 0
    });

    // Oyun bitiş bildirimini güncelle
    const winnerName = playerName;
    // Kazananı tüm oyunculara duyurmak için Firestore'da "winner" adlı bir belge oluştur
    const winnerRef = db.collection("game").doc("winner");
    await winnerRef.set({ name: winnerName });

    questionArea.style.display = "none";
    puzzleDiv.classList.remove("hidden");
    disableButtons();
  } else {
    penaltyCount = (data.wrongCount || 0) + 1;
    const newPenalty = Date.now() + (penaltyCount * 10 * 1000);
    await playerRef.update({
      penaltyUntil: newPenalty,
      wrongCount: penaltyCount
    });
    markButtonWrong(btn);
    checkPenalty();
  }
}

async function listenWinner(){
  const winnerRef = db.collection("game").doc("winner");
  winnerRef.onSnapshot(doc=>{
    if(doc.exists){
      const data = doc.data();
      if(data.name !== playerName && data.name){
        alert(`${data.name} adlı oyuncu oyunu kazandı!`);
        questionArea.style.display = "none";
        puzzleDiv.style.display = "none";
      }
    }
  });
}

document.querySelectorAll("#questionArea button").forEach(b=>{
  b.addEventListener("click", handleAnswer);
});

checkPenalty();
listenWinner();
</script>

</body>
</html>
